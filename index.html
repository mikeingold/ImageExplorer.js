<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Diagram Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 18px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        #container {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f5f5;
        }

        #circuit-viewer {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #circuit-viewer:active {
            cursor: grabbing;
        }

        .area-polygon {
            fill: rgba(59, 130, 246, 0.1);
            stroke: #3b82f6;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .area-polygon:hover {
            fill: rgba(59, 130, 246, 0.3);
            stroke: #2563eb;
            stroke-width: 3;
        }

        .area-polygon.selected {
            fill: rgba(34, 197, 94, 0.3);
            stroke: #16a34a;
            stroke-width: 3;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 300px;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .tooltip-description {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }

        #info-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateX(360px);
            transition: transform 0.3s ease;
            z-index: 100;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        #info-panel.visible {
            transform: translateX(0);
        }

        .info-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 28px;
            height: 28px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .info-close:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            padding-right: 30px;
        }

        .info-section {
            margin-bottom: 16px;
        }

        .info-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            color: #475569;
            line-height: 1.6;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: #475569;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .rotate-icon {
            display: inline-block;
            transition: transform 0.2s;
        }

        .control-btn:hover .rotate-icon {
            transform: rotate(15deg);
        }
    </style>
</head>
<body>
    <div id="banner">Circuit Diagram Explorer</div>
    
    <div id="container">
        <svg id="circuit-viewer"></svg>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-description"></div>
    </div>

    <div id="info-panel">
        <button class="info-close" id="info-close-btn">×</button>
        <div class="info-title"></div>
        <div class="info-content"></div>
    </div>

    <div class="controls">
        <button class="control-btn" id="zoom-in-btn" title="Zoom In">+</button>
        <button class="control-btn" id="zoom-out-btn" title="Zoom Out">−</button>
        <button class="control-btn" id="rotate-left-btn" title="Rotate Left (Q)"><span class="rotate-icon">↶</span></button>
        <button class="control-btn" id="rotate-right-btn" title="Rotate Right (E)"><span class="rotate-icon">↷</span></button>
        <button class="control-btn" id="reset-btn" title="Reset View (R)">⟲</button>
    </div>

    <script>
        // Configuration
        const config = {
            image_url: 'https://upload.wikimedia.org/wikipedia/commons/e/e2/NE555_astable.png',
            image_width: 800,
            image_height: 600,
            areas: [
                {
                    name: 'Power Supply Section',
                    description: 'Main power input and regulation circuit',
                    coordinates: [[50, 50], [250, 50], [250, 150], [50, 150]],
                    details: {
                        voltage: '5V DC',
                        current: '500mA',
                        type: 'Linear Regulator'
                    }
                },
                {
                    name: 'Timer Circuit',
                    description: '555 timer configured in astable mode',
                    coordinates: [[300, 200], [500, 200], [550, 300], [450, 400], [300, 350]],
                    details: {
                        frequency: '1 Hz',
                        duty_cycle: '50%',
                        component: 'NE555'
                    }
                },
                {
                    name: 'Output Stage',
                    description: 'LED driver and current limiting',
                    coordinates: [[600, 100], [750, 100], [750, 250], [600, 250]],
                    details: {
                        max_current: '20mA',
                        resistance: '330Ω',
                        led: 'Red 5mm'
                    }
                }
            ]
        };

        // State
        const create_initial_state = () => ({
            width: 0,
            height: 0,
            transform: d3.zoomIdentity,
            rotation: 0,
            initial_touches: null,
            initial_rotation: 0,
            initial_distance: 0,
            initial_scale: 1
        });

        let state = create_initial_state();

        // DOM elements
        const container = document.getElementById('container');
        const svg = d3.select('#circuit-viewer');
        const tooltip = document.getElementById('tooltip');
        const info_panel = document.getElementById('info-panel');

        // Initialize dimensions
        state.width = container.clientWidth;
        state.height = container.clientHeight;
        svg.attr('width', state.width).attr('height', state.height);

        // Create main group
        const g = svg.append('g');

        // Transform functions
        const get_rotation_center = () => ({
            x: config.image_width / 2,
            y: config.image_height / 2
        });

        const apply_transform = () => {
            const center = get_rotation_center();
            g.attr('transform', 
                `${state.transform} rotate(${state.rotation}, ${center.x}, ${center.y})`
            );
        };

        // Zoom behavior (desktop only)
        const zoom = d3.zoom()
            .scaleExtent([0.5, 10])
            .filter((event) => {
                return event.type !== 'touchstart' && 
                       event.type !== 'touchmove' && 
                       event.type !== 'touchend';
            })
            .on('zoom', (event) => {
                state.transform = event.transform;
                apply_transform();
            });

        svg.call(zoom);

        // Image setup
        g.append('image')
            .attr('href', config.image_url)
            .attr('width', config.image_width)
            .attr('height', config.image_height);

        // Tooltip functions
        const show_tooltip = (area, event) => {
            tooltip.querySelector('.tooltip-title').textContent = area.name;
            tooltip.querySelector('.tooltip-description').textContent = area.description;
            tooltip.classList.add('visible');
            update_tooltip_position(event);
        };

        const update_tooltip_position = (event) => {
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        };

        const hide_tooltip = () => {
            tooltip.classList.remove('visible');
        };

        // Info panel functions
        const format_label = (key) => {
            return key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim();
        };

        const create_info_section = (label, value) => {
            return `
                <div class="info-section">
                    <div class="info-label">${format_label(label)}</div>
                    <div class="info-value">${value}</div>
                </div>
            `;
        };

        const show_info_panel = (area) => {
            info_panel.querySelector('.info-title').textContent = area.name;
            
            let content = create_info_section('description', area.description);
            
            if (area.details) {
                Object.entries(area.details).forEach(([key, value]) => {
                    content += create_info_section(key, value);
                });
            }
            
            info_panel.querySelector('.info-content').innerHTML = content;
            info_panel.classList.add('visible');
        };

        const close_info_panel = () => {
            info_panel.classList.remove('visible');
            d3.selectAll('.area-polygon').classed('selected', false);
        };

        // Area rendering
        const create_area_polygon = (area, index) => {
            const points_string = area.coordinates
                .map(p => p.join(','))
                .join(' ');

            return g.append('g')
                .attr('class', 'areas')
                .append('polygon')
                .attr('class', 'area-polygon')
                .attr('points', points_string)
                .attr('data-index', index)
                .on('mouseenter', (event) => show_tooltip(area, event))
                .on('mousemove', (event) => update_tooltip_position(event))
                .on('mouseleave', () => hide_tooltip())
                .on('click', function(event) {
                    event.stopPropagation();
                    show_info_panel(area);
                    d3.selectAll('.area-polygon').classed('selected', false);
                    d3.select(this).classed('selected', true);
                });
        };

        config.areas.forEach((area, index) => {
            create_area_polygon(area, index);
        });

        // Touch gesture handling
        const get_touch_distance = (touches) => {
            const dx = touches[1].clientX - touches[0].clientX;
            const dy = touches[1].clientY - touches[0].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        };

        const get_touch_angle = (touches) => {
            return Math.atan2(
                touches[1].clientY - touches[0].clientY,
                touches[1].clientX - touches[0].clientX
            );
        };

        const handle_touch_start = (event) => {
            if (event.touches.length === 2) {
                event.preventDefault();
                event.stopPropagation();
                
                state.initial_touches = Array.from(event.touches).map(t => ({
                    x: t.clientX,
                    y: t.clientY
                }));
                
                state.initial_rotation = state.rotation;
                state.initial_distance = get_touch_distance(event.touches);
                state.initial_scale = state.transform.k;
            }
        };

        const handle_touch_move = (event) => {
            if (event.touches.length === 2 && state.initial_touches) {
                event.preventDefault();
                event.stopPropagation();
                
                // Calculate rotation
                const initial_angle = Math.atan2(
                    state.initial_touches[1].y - state.initial_touches[0].y,
                    state.initial_touches[1].x - state.initial_touches[0].x
                );
                
                const current_angle = get_touch_angle(event.touches);
                const angle_diff = (current_angle - initial_angle) * (180 / Math.PI);
                state.rotation = state.initial_rotation + angle_diff;
                
                // Calculate zoom
                const current_distance = get_touch_distance(event.touches);
                const scale_factor = current_distance / state.initial_distance;
                const new_scale = Math.max(0.5, Math.min(10, state.initial_scale * scale_factor));
                
                // Calculate center point for zoom
                const center_x = (event.touches[0].clientX + event.touches[1].clientX) / 2;
                const center_y = (event.touches[0].clientY + event.touches[1].clientY) / 2;
                
                // Update transform
                const svg_node = svg.node();
                const rect = svg_node.getBoundingClientRect();
                const svg_x = center_x - rect.left;
                const svg_y = center_y - rect.top;
                
                // Apply scale change around touch center
                const scale_change = new_scale / state.transform.k;
                state.transform = state.transform.translate(
                    (svg_x - state.transform.x) * (1 - scale_change) / state.transform.k,
                    (svg_y - state.transform.y) * (1 - scale_change) / state.transform.k
                ).scale(scale_change);
                
                apply_transform();
            }
        };

        const handle_touch_end = (event) => {
            if (event.touches.length < 2) {
                state.initial_touches = null;
            }
        };

        // Attach touch listeners
        const svg_node = svg.node();
        svg_node.addEventListener('touchstart', handle_touch_start, { passive: false });
        svg_node.addEventListener('touchmove', handle_touch_move, { passive: false });
        svg_node.addEventListener('touchend', handle_touch_end, { passive: false });

        // Control functions
        const zoom_in = () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
        };

        const zoom_out = () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.67);
        };

        const snap_to_45_degree_increment = (current_rotation, direction) => {
            const normalized = ((current_rotation % 360) + 360) % 360;
            const current_increment = Math.round(normalized / 45);
            const next_increment = direction === 'left' 
                ? current_increment - 1 
                : current_increment + 1;
            return next_increment * 45;
        };

        const rotate_left = () => {
            state.rotation = snap_to_45_degree_increment(state.rotation, 'left');
            g.transition().duration(300).tween('rotate', () => {
                return () => apply_transform();
            });
        };

        const rotate_right = () => {
            state.rotation = snap_to_45_degree_increment(state.rotation, 'right');
            g.transition().duration(300).tween('rotate', () => {
                return () => apply_transform();
            });
        };

        const reset_view = () => {
            state.rotation = 0;
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        };

        const fit_image_to_view = () => {
            const scale = Math.min(
                state.width / config.image_width, 
                state.height / config.image_height
            ) * 0.9;
            
            const x = (state.width - config.image_width * scale) / 2;
            const y = (state.height - config.image_height * scale) / 2;
            
            const initial_transform = d3.zoomIdentity.translate(x, y).scale(scale);
            svg.call(zoom.transform, initial_transform);
        };

        // Event listeners
        document.getElementById('zoom-in-btn').addEventListener('click', zoom_in);
        document.getElementById('zoom-out-btn').addEventListener('click', zoom_out);
        document.getElementById('rotate-left-btn').addEventListener('click', rotate_left);
        document.getElementById('rotate-right-btn').addEventListener('click', rotate_right);
        document.getElementById('reset-btn').addEventListener('click', reset_view);
        document.getElementById('info-close-btn').addEventListener('click', close_info_panel);

        svg.on('click', close_info_panel);

        window.addEventListener('resize', () => {
            state.width = container.clientWidth;
            state.height = container.clientHeight;
            svg.attr('width', state.width).attr('height', state.height);
        });

        // Keyboard shortcuts
        const handle_keydown = (event) => {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            const key_actions = {
                'q': rotate_left,
                'e': rotate_right,
                'r': reset_view,
                '+': zoom_in,
                '=': zoom_in,
                '-': zoom_out,
                '_': zoom_out
            };
            
            const action = key_actions[event.key.toLowerCase()];
            if (action) {
                action();
            }
        };

        document.addEventListener('keydown', handle_keydown);

        // Initialize view
        fit_image_to_view();
    </script>
</body>
</html>